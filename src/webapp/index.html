<!doctype html>
<html lang="ru">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Gurenko Mini App</title>
    <style>
      :root {
        --bg: #0b0c10;
        --card: #14161d;
        --text: #e7e9ee;
        --muted: #9aa3b2;
        --border: #2a2f3a;
        --radius: 18px;
      }
      body {
        margin: 0;
        font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
        background: var(--bg);
        color: var(--text);
      }
      .wrap {
        max-width: 960px;
        margin: 0 auto;
        padding: 16px;
      }
      .row {
        display: grid;
        grid-template-columns: 1.2fr 0.8fr;
        gap: 14px;
      }
      @media (max-width: 880px) {
        .row { grid-template-columns: 1fr; }
      }
      .card {
        background: var(--card);
        border: 1px solid var(--border);
        border-radius: var(--radius);
        padding: 14px;
      }
      .title {
        font-weight: 800;
        font-size: 18px;
        margin: 0 0 10px;
      }
      .muted { color: var(--muted); }
      .btn {
        display: inline-flex;
        align-items: center;
        justify-content: center;
        gap: 8px;
        padding: 10px 12px;
        border-radius: 14px;
        border: 1px solid var(--border);
        background: #1b1f2a;
        color: var(--text);
        cursor: pointer;
        user-select: none;
      }
      .btn:disabled {
        opacity: 0.5;
        cursor: not-allowed;
      }
      .btn-primary {
        background: #2a74ff;
        border-color: #2a74ff;
      }
      .btn-ghost {
        background: transparent;
      }
      .grid {
        display: grid;
        grid-template-columns: repeat(3, 1fr);
        gap: 10px;
      }
      @media (max-width: 560px) {
        .grid { grid-template-columns: 1fr; }
      }
      input, textarea {
        width: 100%;
        background: #0f1117;
        color: var(--text);
        border: 1px solid var(--border);
        border-radius: 14px;
        padding: 12px;
        outline: none;
      }
      textarea { min-height: 110px; resize: vertical; }
      .pill {
        display: inline-flex;
        align-items: center;
        gap: 6px;
        padding: 6px 10px;
        border-radius: 999px;
        background: #0f1117;
        border: 1px solid var(--border);
        color: var(--muted);
        font-size: 13px;
      }
      .list {
        display: grid;
        gap: 10px;
      }
      .promptItem {
        padding: 12px;
        border-radius: 16px;
        border: 1px solid var(--border);
        background: #0f1117;
      }
      .promptItem h4 {
        margin: 0 0 6px;
        font-size: 15px;
      }
      .promptItem pre {
        margin: 0;
        white-space: pre-wrap;
        color: var(--muted);
        font-size: 13px;
      }
      .topbar {
        display: flex;
        justify-content: space-between;
        align-items: center;
        gap: 12px;
        margin-bottom: 14px;
      }
      .kpi {
        display: flex;
        gap: 10px;
        flex-wrap: wrap;
      }
      .img {
        width: 100%;
        border-radius: 18px;
        border: 1px solid var(--border);
        margin-top: 12px;
      }
      .hr {
        height: 1px;
        background: var(--border);
        margin: 12px 0;
      }
      .toast {
        position: fixed;
        left: 50%;
        bottom: 14px;
        transform: translateX(-50%);
        background: #0f1117;
        border: 1px solid var(--border);
        border-radius: 14px;
        padding: 10px 12px;
        max-width: 92vw;
        color: var(--text);
        display: none;
      }
    </style>
  </head>
  <body>
    <div class="wrap">
      <div class="topbar">
        <div>
          <div class="title">Gurenko Mini App</div>
          <div class="muted" id="hello">–ó–∞–≥—Ä—É–∑–∫–∞‚Ä¶</div>
        </div>
        <div class="kpi">
          <span class="pill" id="creditsPill">‚≠êÔ∏è –ì–µ–Ω–µ—Ä–∞—Ü–∏–∏: ‚Ä¶</span>
          <span class="pill" id="spentPill">üí´ Stars: ‚Ä¶</span>
        </div>
      </div>

      <div class="row">
        <div class="card">
          <div class="title">üé® –ì–µ–Ω–µ—Ä–∞—Ü–∏—è</div>
          <div class="muted">1 –≥–µ–Ω–µ—Ä–∞—Ü–∏—è = 1 –∫—Ä–µ–¥–∏—Ç. –ü–æ–∫—É–ø–∫–∞ ‚Äî –∑–∞ Telegram Stars.</div>
          <div style="margin-top: 12px;">
            <textarea id="prompt" placeholder="–í—Å—Ç–∞–≤—å —Å–≤–æ–π –ø—Ä–æ–º—Ç —Å—é–¥–∞‚Ä¶"></textarea>
          </div>
          <div style="margin-top: 10px; display:flex; gap:10px; flex-wrap:wrap;">
            <button class="btn btn-primary" id="genBtn">‚ö° –°–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å</button>
            <button class="btn btn-ghost" id="clearBtn">–û—á–∏—Å—Ç–∏—Ç—å</button>
            <button class="btn" id="shareBotBtn">üîó –ü–æ–¥–µ–ª–∏—Ç—å—Å—è –±–æ—Ç–æ–º</button>
            <button class="btn" id="statusBtn">üìå –í —Å—Ç–∞—Ç—É—Å</button>
          </div>

          <img id="preview" class="img" style="display:none" alt="result" />

          <div class="hr"></div>
          <div class="title">üìö –°–≤–µ–∂–∏–µ –ø—Ä–æ–º—Ç—ã –∏–∑ –∫–∞–Ω–∞–ª–∞</div>
          <div class="list" id="prompts"></div>
        </div>

        <div class="card">
          <div class="title">üë§ –ü—Ä–æ—Ñ–∏–ª—å</div>
          <div class="muted" id="profileText">–ó–∞–≥—Ä—É–∑–∫–∞‚Ä¶</div>
          <div class="hr"></div>
          <div class="title">üí´ –ö—É–ø–∏—Ç—å –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏</div>
          <div class="grid" id="packs"></div>
          <div class="muted" style="margin-top: 10px;">
            –û–ø–ª–∞—Ç–∞ –∏–¥–µ—Ç —á–µ—Ä–µ–∑ *Telegram Stars* (–≤–∞–ª—é—Ç–∞ XTR). –ü–æ—Å–ª–µ –æ–ø–ª–∞—Ç—ã –∫—Ä–µ–¥–∏—Ç—ã –Ω–∞—á–∏—Å–ª—è—Ç—Å—è –≤ –ø—Ä–æ—Ñ–∏–ª—å.
          </div>
        </div>
      </div>
    </div>

    <div class="toast" id="toast"></div>

    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <script>
      const tg = window.Telegram?.WebApp;
      const initData = tg?.initData || '';
      const headers = { 'Content-Type': 'application/json', 'X-Telegram-InitData': initData };

      const el = {
        hello: document.getElementById('hello'),
        creditsPill: document.getElementById('creditsPill'),
        spentPill: document.getElementById('spentPill'),
        prompt: document.getElementById('prompt'),
        genBtn: document.getElementById('genBtn'),
        clearBtn: document.getElementById('clearBtn'),
        shareBotBtn: document.getElementById('shareBotBtn'),
        statusBtn: document.getElementById('statusBtn'),
        preview: document.getElementById('preview'),
        prompts: document.getElementById('prompts'),
        profileText: document.getElementById('profileText'),
        packs: document.getElementById('packs'),
        toast: document.getElementById('toast'),
      };

      let state = {
        user: null,
        deepLink: null,
        lastUrl: null,
      };

      function toast(msg) {
        el.toast.textContent = msg;
        el.toast.style.display = 'block';
        setTimeout(() => (el.toast.style.display = 'none'), 2200);
      }

      function renderProfile() {
        if (!state.user) return;
        const name = [state.user.first_name, state.user.last_name].filter(Boolean).join(' ') || '–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å';
        el.hello.textContent = `–ü—Ä–∏–≤–µ—Ç, ${name} üëã`;
        el.creditsPill.textContent = `‚≠êÔ∏è –ì–µ–Ω–µ—Ä–∞—Ü–∏–∏: ${state.user.credits}`;
        el.spentPill.textContent = `üí´ Stars: ${state.user.total_spent_stars || 0}`;

        const username = state.user.username ? '@' + state.user.username : '(–±–µ–∑ –Ω–∏–∫–∞)';
        el.profileText.innerHTML = `
          <div><b>${username}</b></div>
          <div class="muted" style="margin-top:6px;">ID: <code>${state.user.user_id}</code></div>
          ${state.deepLink ? `<div class="muted" style="margin-top:10px;">–¢–≤–æ—è —Å—Å—ã–ª–∫–∞: <br><span style="word-break:break-all;">${state.deepLink}</span></div>` : ''}
        `;

        el.statusBtn.disabled = !state.lastUrl;
      }

      function makeShareUrl() {
        const deep = state.deepLink || '';
        const text = encodeURIComponent('–î–µ—Ä–∂–∏ –±–æ—Ç —Å –ø—Ä–æ–º—Ç–∞–º–∏ –∏ –≥–µ–Ω–µ—Ä–∞—Ü–∏–µ–π üî•');
        const url = encodeURIComponent(deep);
        return `https://t.me/share/url?url=${url}&text=${text}`;
      }

      async function apiGet(path) {
        const r = await fetch(path, { headers });
        const j = await r.json().catch(() => ({}));
        if (!r.ok) throw Object.assign(new Error(j?.error || 'error'), { status: r.status, data: j });
        return j;
      }

      async function apiPost(path, body) {
        const r = await fetch(path, { method: 'POST', headers, body: JSON.stringify(body || {}) });
        const j = await r.json().catch(() => ({}));
        if (!r.ok) throw Object.assign(new Error(j?.error || 'error'), { status: r.status, data: j });
        return j;
      }

      async function loadMe() {
        const me = await apiGet('/api/me');
        state.user = me.user;
        state.deepLink = me.deepLink;
        state.lastUrl = me.user?.last_result_url || null;
        renderProfile();
      }

      async function loadPrompts() {
        const data = await apiGet('/api/prompts');
        el.prompts.innerHTML = '';
        (data.items || []).slice(0, 12).forEach((p) => {
          const item = document.createElement('div');
          item.className = 'promptItem';
          const title = p.title || '–ü—Ä–æ–º—Ç';
          item.innerHTML = `
            <h4>${title}</h4>
            <pre>${(p.text || '').slice(0, 500)}${(p.text || '').length > 500 ? '‚Ä¶' : ''}</pre>
            <div style="margin-top:10px; display:flex; gap:10px; flex-wrap:wrap;">
              <button class="btn" data-use="${p.id}">–ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å</button>
              <button class="btn btn-ghost" data-copy="${p.id}">–ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å</button>
            </div>
          `;
          item.querySelector('[data-use]').onclick = () => {
            el.prompt.value = p.text || '';
            toast('–ü—Ä–æ–º—Ç –ø–æ–¥—Å—Ç–∞–≤–ª–µ–Ω ‚úÖ');
          };
          item.querySelector('[data-copy]').onclick = async () => {
            try {
              await navigator.clipboard.writeText(p.text || '');
              toast('–°–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–æ ‚úÖ');
            } catch {
              toast('–ù–µ —É–¥–∞–ª–æ—Å—å —Å–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å üôà');
            }
          };
          el.prompts.appendChild(item);
        });
      }

      function renderPacks() {
        const packs = [
          { id: 'p10', title: '10 –≥–µ–Ω–µ—Ä–∞—Ü–∏–π', stars: 49 },
          { id: 'p30', title: '30 –≥–µ–Ω–µ—Ä–∞—Ü–∏–π', stars: 129 },
          { id: 'p100', title: '100 –≥–µ–Ω–µ—Ä–∞—Ü–∏–π', stars: 399 },
        ];
        el.packs.innerHTML = '';
        packs.forEach((p) => {
          const b = document.createElement('button');
          b.className = 'btn';
          b.textContent = `${p.title}\n${p.stars}‚≠êÔ∏è`;
          b.style.whiteSpace = 'pre-line';
          b.onclick = () => buyPack(p.id);
          el.packs.appendChild(b);
        });
      }

      async function buyPack(packId) {
        try {
          el.genBtn.disabled = true;
          const { url } = await apiPost('/api/invoice', { pack_id: packId });
          if (!tg?.openInvoice) {
            toast('–û—Ç–∫—Ä–æ–π Mini App –≤ Telegram üôè');
            return;
          }
          tg.openInvoice(url, async (status) => {
            // status: 'paid' | 'cancelled' | 'failed' | 'pending'
            if (status === 'paid') {
              toast('–û–ø–ª–∞—Ç–∞ —É—Å–ø–µ—à–Ω–∞ ‚úÖ');
              await loadMe();
            } else {
              toast('–û–ø–ª–∞—Ç–∞ –Ω–µ –∑–∞–≤–µ—Ä—à–µ–Ω–∞');
            }
          });
        } catch (e) {
          if (e.status === 403 && e.data?.error === 'not_subscribed') {
            toast('–°–Ω–∞—á–∞–ª–∞ –ø–æ–¥–ø–∏—à–∏—Å—å –Ω–∞ –∫–∞–Ω–∞–ª üôè');
          } else {
            toast('–û—à–∏–±–∫–∞ –æ–ø–ª–∞—Ç—ã üôà');
          }
        } finally {
          el.genBtn.disabled = false;
        }
      }

      async function generate() {
        const prompt = (el.prompt.value || '').trim();
        if (!prompt) {
          toast('–ù–∞–ø–∏—à–∏ –ø—Ä–æ–º—Ç üòÖ');
          return;
        }

        try {
          el.genBtn.disabled = true;
          toast('–ì–µ–Ω–µ—Ä–∏—Ä—É—é‚Ä¶ ‚è≥');

          const res = await apiPost('/api/generate', {
            prompt,
            aspect_ratio: 'social_story_9_16',
          });

          if (res.url) {
            el.preview.src = res.url;
            el.preview.style.display = 'block';
            state.lastUrl = res.url;
            el.statusBtn.disabled = false;
            await loadMe();
            toast('–ì–æ—Ç–æ–≤–æ ‚úÖ');
          } else {
            toast('–ó–∞–ø—Ä–æ—Å –ø—Ä–∏–Ω—è—Ç ‚úÖ –û–±–Ω–æ–≤–∏ –ø–æ–∑–∂–µ');
            await loadMe();
          }
        } catch (e) {
          if (e.status === 402) {
            toast('–ù–µ—Ç –≥–µ–Ω–µ—Ä–∞—Ü–∏–π üòå –ö—É–ø–∏ –ø–∞–∫–µ—Ç');
          } else {
            toast('–û—à–∏–±–∫–∞ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ üôà');
          }
          await loadMe().catch(() => {});
        } finally {
          el.genBtn.disabled = false;
        }
      }

      function shareBot() {
        const url = makeShareUrl();
        if (tg?.openTelegramLink) {
          tg.openTelegramLink(url);
        } else {
          window.open(url, '_blank');
        }
      }

      async function shareToStatus() {
        if (!state.lastUrl) {
          toast('–°–Ω–∞—á–∞–ª–∞ —Å–¥–µ–ª–∞–π –≥–µ–Ω–µ—Ä–∞—Ü–∏—é üôÇ');
          return;
        }
        if (!tg?.shareToStory) {
          toast('–≠—Ç–∞ —Ñ—É–Ω–∫—Ü–∏—è –¥–æ—Å—Ç—É–ø–Ω–∞ –≤ Telegram (Stories)');
          return;
        }
        try {
          tg.shareToStory(state.lastUrl, {
            text: '–°–¥–µ–ª–∞–Ω–æ –≤ AI ‚ú®',
          });
        } catch {
          toast('–ù–µ —É–¥–∞–ª–æ—Å—å –æ—Ç–∫—Ä—ã—Ç—å —Å—Ç–æ—Ä–∏—Å üôà');
        }
      }

      el.genBtn.onclick = generate;
      el.clearBtn.onclick = () => (el.prompt.value = '');
      el.shareBotBtn.onclick = shareBot;
      el.statusBtn.onclick = shareToStatus;

      (async function init() {
        try {
          if (tg) {
            tg.expand();
            tg.ready();
          }
          renderPacks();
          await loadMe();
          await loadPrompts();
        } catch (e) {
          toast('–ù–µ –º–æ–≥—É –∑–∞–≥—Ä—É–∑–∏—Ç—å –¥–∞–Ω–Ω—ã–µ üôà');
        }
      })();
    </script>
  </body>
</html>
